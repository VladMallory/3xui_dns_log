# X-UI Log Management Tools

Набор инструментов для управления логами X-UI панели, включающий архивирование и объединение логов.

## Структура проекта

```
tools/
├── 3xui_dns_log/
│   ├── archive_logs/           # Система архивирования логов
│   │   ├── main.go            # Главная интерактивная программа
│   │   ├── archiver/          # Модуль архивирования
│   │   ├── installer/         # Модуль установки автозапуска
│   │   ├── sh/               # Bash скрипты (устарели)
│   │   └── README.md         # Документация архиватора
│   └── merge_logs/           # Система объединения логов
│       ├── merge_log.go      # Программа объединения
│       └── build.sh          # Скрипт сборки
└── README.md                 # Этот файл
```

## Компоненты

### 1. X-UI Log Archiver (`3xui_dns_log/archive_logs/`)

**Интерактивная программа для архивирования логов X-UI панели**

#### Функциональность:
- **Автоматическое архивирование**: Читает новые строки из `/usr/local/x-ui/access.log` и добавляет их во временный накопитель
- **Часовое архивирование**: В начале каждого часа (минута 00) создает сжатый архив из накопителя
- **Очистка старых архивов**: Автоматически удаляет архивы старше 30 дней
- **Управление автозапуском**: Установка/удаление автоматического выполнения через cron
- **Логирование**: Ведет подробный лог работы в `/usr/local/x-ui/archives/archive.log`

#### Интерактивное меню:
1. **Сделать архивирование сейчас** - немедленное выполнение
2. **Добавить в автозапуск** - установка cron задачи (каждые 10 минут)
3. **Удалить из автозапуска** - отключение автоматического выполнения
4. **Показать статус автозапуска** - проверка текущего состояния
5. **Выход** - завершение работы

#### Установка и использование:

```bash
# Компиляция
cd 3xui_dns_log/archive_logs
go build -o xui_log_archiver main.go

# Запуск (требуются права root)
sudo ./xui_log_archiver

# Автоматический режим для cron
sudo ./xui_log_archiver --cron
```

### 2. Merge Log Tool (`3xui_dns_log/merge_logs/`)

**Утилита для объединения и обработки архивных логов**

#### Функциональность:
- Создает необходимые директории (`/usr/local/x-ui/mergelog/logs`)
- Копирует все `.gz` архивы из `/usr/local/x-ui/archives` в директорию логов
- Распаковывает все `.gz` файлы
- Объединяет все `.log` файлы в один, сортируя и удаляя дубликаты
- Сохраняет результат в `/usr/local/x-ui/mergelog/merged_access.log`
- Очищает временные `.log` файлы
- Создает тестовые архивы, если исходная директория пуста

#### Компиляция и запуск:

```bash
# Вариант 1: Использовать build.sh
cd 3xui_dns_log/merge_logs
./build.sh

# Вариант 2: Компилировать напрямую
go build -o merge_log merge_log.go

# Запуск
./merge_log
```

## Требования

### Общие требования:
- Go 1.21 или выше
- Linux система (тестировано на Ubuntu/Debian)
- Права root для установки архиватора

### Для архиватора:
- Права на запись в `/usr/local/x-ui/archives/`
- Права на чтение из `/usr/local/x-ui/access.log`
- Утилиты: `gzip`, `find`

### Для merge_log:
- Права на запись в `/usr/local/x-ui/mergelog/`
- Права на чтение из `/usr/local/x-ui/archives/`

## Рекомендуемый workflow

1. **Установка архиватора**:
   ```bash
   cd 3xui_dns_log/archive_logs
   go build -o xui_log_archiver main.go
   sudo ./xui_log_archiver
   # Выберите пункт 2 для установки автозапуска
   ```

2. **Периодическое объединение логов**:
   ```bash
   cd 3xui_dns_log/merge_logs
   go build -o merge_log merge_log.go
   ./merge_log
   ```

## Конфигурация

### Архиватор
Все пути настраиваются через константы в файлах:
- `archiver/archiver.go`: основные пути к логам и архивам
- `installer/installer.go`: пути для установки

### Merge Log
Пути настраиваются в `merge_logs/merge_log.go`:
- `ARCHIVE_SOURCE_DIR` - исходная директория с архивами
- `MERGE_DEST_DIR` - директория для объединенных логов
- `MERGED_LOG_FILE` - итоговый файл с объединенными логами

## Логирование

- **Архиватор**: Логи работы сохраняются в `/usr/local/x-ui/archives/archive.log`
- **Merge Log**: Выводит информацию о процессе в консоль

## Автоматизация

После установки архиватор будет автоматически выполняться каждые 10 минут через crontab, создавая часовые архивы в начале каждого часа.

## Отличия от bash-версий

- Более детальная обработка ошибок
- Логирование предупреждений вместо игнорирования ошибок
- Более эффективная работа с памятью при обработке больших файлов
- Кроссплатформенность (работает на Linux, macOS, Windows)
- Интерактивный интерфейс для управления
- Модульная архитектура с разделением ответственности
